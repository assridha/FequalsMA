<script type="module">
    const createSidebar = (toc, moduleID) => {
        const sidebarHandler = document.getElementById('sidebar-handler');
        sidebarHandler.innerHTML = ''; // Clear existing content

        let linkObject = [moduleID];
        let part = toc.parts.filter(part => part._id.equals(moduleID));
        if (part.length > 0) {
            linkObject.push(part[0].parent);
        } else {
            let chapter = toc.chapters.filter(chapter => chapter._id.equals(moduleID));
            if (chapter.length > 0) {
                linkObject.push(chapter[0].parent);
                part = toc.parts.filter(part => part._id.equals(chapter[0].parent));
                if (part.length > 0) {
                    linkObject.push(part[0].parent);
                }
            }
        }
        linkObject.reverse();

        let subjectsSort = toc.subjects.filter(subject => subject._id.equals(linkObject[0]));
        subjectsSort.forEach((subject, i) => {
            const subjectSpan = document.createElement('span');
            const subjectLink = document.createElement('a');
            subjectLink.href = `/module?id=${subject._id}`;
            subjectLink.id = `subject${i}`;
            subjectLink.className = 'sidebar-text';
            subjectLink.textContent = subject.title;
            subjectSpan.appendChild(subjectLink);
            sidebarHandler.appendChild(subjectSpan);

            const toggleLink = document.createElement('a');
            toggleLink.dataset.bsToggle = "collapse";
            toggleLink.href = `#collapseList${i}`;
            toggleLink.id = `link_${i}`;
            toggleLink.role = "button";
            toggleLink.ariaExpanded = "false";
            toggleLink.ariaControls = `collapseList${i}`;
            toggleLink.className = "sidebar-text";
            toggleLink.style.textDecoration = "none";
            toggleLink.textContent = "[+]";
            sidebarHandler.appendChild(toggleLink);

            toggleLink.addEventListener("click", function() {
                const plusMinus = document.getElementById(`plus_minus_${i}`);
                plusMinus.textContent = plusMinus.textContent === "+" ? "-" : "+";
            });

            const partsSort = toc.parts.filter((part) => part.parent.equals(subject._id)).sort((a, b) => (a.index > b.index) ? 1 : -1);
            const partsList = document.createElement('ul');
            partsList.className = "collapse sidebar-text";
            partsList.id = `collapseList${i}`;

            partsSort.forEach((part, j) => {
                const partItem = document.createElement('li');
                partItem.className = "nav-item";

                const partSpan = document.createElement('span');
                const partLink = document.createElement('a');
                partLink.href = `/module?id=${part._id}`;
                partLink.id = `part${i}_${j}`;
                partLink.className = "sidebar-text";
                partLink.textContent = part.title;
                partSpan.appendChild(partLink);
                partItem.appendChild(partSpan);

                const chapterToggleLink = document.createElement('a');
                chapterToggleLink.dataset.bsToggle = "collapse";
                chapterToggleLink.href = `#collapseList${i}_${j}`;
                chapterToggleLink.id = `link_${i}_${j}`;
                chapterToggleLink.role = "button";
                chapterToggleLink.ariaExpanded = "false";
                chapterToggleLink.ariaControls = `collapseList${i}_${j}`;
                chapterToggleLink.className = "sidebar-text";
                chapterToggleLink.style.textDecoration = "none";
                chapterToggleLink.textContent = "[+]";
                partItem.appendChild(chapterToggleLink);

                chapterToggleLink.addEventListener("click", function () {
                    const plusMinus = document.getElementById(`plus_minus_${i}_${j}`);
                    plusMinus.textContent = plusMinus.textContent === "+" ? "-" : "+";
                });

                partsList.appendChild(partItem);
            });

            sidebarHandler.appendChild(partsList);
        });
    };
</script>
