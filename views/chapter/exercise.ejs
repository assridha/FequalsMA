<% layout('layouts/boilerplate') %>

    <h1>
       Exercises for <%=chapter.title%>
    </h1>

    <!-- render all exercise -->
    <% for (let i=0; i < chapter.exercises.length; i++) { %>

        <h2>Exercise <%=i+1%>
            <!-- anchor tag to edit exercise route -->
            <a href="/pola/subject/part/chapter/<%= chapter.exercises[i]._id%>/editExercise"
                style="text-decoration: none;vertical-align: super;font-size: medium;">‚úèÔ∏è</a>
            <!-- form to delete exercise -->
            <form style="display: inline-block;"
                action="/pola/subject/part/chapter/<%= chapter.exercises[i]._id%>/deleteExercise?_method=DELETE" method="POST">
                <!-- anchor tag that submits form on click -->
                <a href="#" onclick="parentNode.submit(); return false;"
                    style="text-decoration: none;vertical-align: super;font-size: medium;">üóëÔ∏è</a>
            </form>
        </h2>
        <p>
            <%- chapter.exercises[i].problem %>
        </p>
        <!-- display figure in exercises -->
        <% if (chapter.exercises[i].figure) { %>
            <figure class="text-center">
            <img src="<%= chapter.exercises[i].figure %>" class="img-fluid" alt="..." width="200">
            </figure>
        <% } %>

        <!-- display form if type is "MCQ" -->
        <% if (chapter.exercises[i].type == "MCQ") { %>
            <!-- get answer from answers by matching the id -->
            <% let answer = answers.find((answer) => chapter.exercises[i]._id.equals(answer._id)) %>
        <!-- display all options in a radio selection form -->
        
            <% for (let j=0; j < chapter.exercises[i].options.length; j++) { %>
                <div class="form-check">
                <input class="form-check-input" type="radio" name="answer<%=i%>" id="flexRadioDefault<%=chapter.exercises[i].options[j]%>" value="<%=j%>">
                <label class="form-check-label" for="flexRadioDefault<%=chapter.exercises[i].options[j]%>">
                    <%= chapter.exercises[i].options[j] %>
                </label>
              </div>

            <% } %>
            <button type="button" class="btn btn-primary" id="button<%=i%>">Submit</button><span id="span_<%=i%>"></span>
            <!-- script to detect which option has been clicked on button press  -->
            <script>
                document.getElementById("button<%=i%>").addEventListener("click", function() {
                    let answer = document.querySelector('input[name="answer<%=i%>"]:checked').value;
                    // console.log(answer);
                    // console.log("<%=chapter.exercises[i].answer%>");
                    // console.log(answer == "<%=chapter.exercises[i].answer%>");

                    // get correct answer by sending answer via post request to the /pola/subject/part/chapter/<%= chapter.exercises[i]._id%>/answer route
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "/pola/subject/part/chapter/<%= chapter.exercises[i]._id%>/answer", true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send(JSON.stringify({answer: answer}));

                    // wait for response
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState == 4 && xhr.status == 200) {
                            // console.log(xhr.responseText);
                            // alert user if answer is correct or incorrect
                            if (xhr.responseText == "true") {
                                alert("Correct!");
                                // insert green tick in span tag
                                document.getElementById("span_<%=i%>").innerHTML = "‚úÖ";
                            } else {
                                alert("Incorrect!");
                                // insert red cross in span tag
                                document.getElementById("span_<%=i%>").innerHTML = "‚ùå";
                            }
                        }
                    }
                });
            </script>
        <% } %>
        <!-- condition to display form if type is "MAQ" (multiple answer question)-->
        <% if (chapter.exercises[i].type == "MAQ") { %>
        <!-- display all options in a checkbox selection form -->
            <% for (let j=0; j < chapter.exercises[i].options.length; j++) { %>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="answer<%=i%>" id="flexCheckDefault<%=chapter.exercises[i].options[j]%>" value="<%=j%>">
                <label class="form-check-label" for="flexCheckDefault<%=chapter.exercises[i].options[j]%>">
                    <%= chapter.exercises[i].options[j] %>
                </label>
              </div>
            <% } %>
            <button type="button" class="btn btn-primary" id="button<%=i%>">Submit</button><span id="span_<%=i%>"></span>
        <!-- script to retrive all the checked answers upon button click. answers should be arranged in a array and post to /pola/subject/part/chapter/<%= chapter.exercises[i]._id%>/answer. Get response if answer was correct -->
        <script>
            document.getElementById("button<%=i%>").addEventListener("click", function() {
                let answer = document.querySelectorAll('input[name="answer<%=i%>"]:checked');
                let answerArray = [];
                for (let i=0; i < answer.length; i++) {
                    answerArray.push(answer[i].value);
                }
                // console.log(answerArray);
                // console.log("<%=chapter.exercises[i].answer%>");
                // console.log(answerArray == "<%=chapter.exercises[i].answer%>");

                // get correct answer by sending answer via post request to the /pola/subject/part/chapter/<%= chapter.exercises[i]._id%>/answer route
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/pola/subject/part/chapter/<%= chapter.exercises[i]._id%>/answer", true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify({answer: answerArray}));

                // wait for response
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        // console.log(xhr.responseText);
                        // alert user if answer is correct or incorrect
                        if (xhr.responseText == "true") {
                            alert("Correct!");
                            // insert green tick in span tag
                            document.getElementById("span_<%=i%>").innerHTML = "‚úÖ";
                        } else {
                            alert("Incorrect!");
                            // insert red cross in span tag
                            document.getElementById("span_<%=i%>").innerHTML = "‚ùå";
                        }
                    }
                }
            });
        </script>
        
            <% } %> 


        <!-- condition to display form if type is "Numeric" -->
        <% if (chapter.exercises[i].type == "Numeric") { %>
        <!-- display input form for numeric answer -->
        
            <div class="card" style="width: 22rem;">
                <div class="card-body">
                    <div style="width: 15rem; display: inline-block;">
                        <label for="exampleFormControlInput1" class="form-label">Answer</label>
                        <input name="answer<%=i%>" type="number" class="form-control" id="exampleFormControlInput1" placeholder="Enter your answer">
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn btn-primary" id="button<%=i%>">Submit</button><span id="span_<%=i%>"></span>
        
        <!--script to obtain numeric answer upon button submission and post it to /pola/subject/part/chapter/<%= chapter.exercises[i]._id%>/answer route and check if answer is correct  -->
        <script>
            document.getElementById("button<%=i%>").addEventListener("click", function() {
                let answer = document.querySelector('input[name="answer<%=i%>"]').value;
                // console.log(answer == "<%=chapter.exercises[i].answer%>");

                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/pola/subject/part/chapter/<%= chapter.exercises[i]._id%>/answer", true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify({answer: answer}));

                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        // console.log(xhr.responseText);
                        if (xhr.responseText == "true") {
                            alert("Correct!");
                            document.getElementById("span_<%=i%>").innerHTML = "‚úÖ";
                        } else {
                            alert("Incorrect!");
                            document.getElementById("span_<%=i%>").innerHTML = "‚ùå";
                        }
                    }
                }
            });
        </script>

        <% } %>

        <% } %>
        <br>
    <h2>Add new exercise</h2>
            <!-- form to create new exercise. create POST route to pola/subject/part/<chapter>/exercise -->
            <form action="/pola/subject/part/<%=chapter._id%>/exercises" method="POST">
                <div class="card mb-3" style="max-width: 540px;">
                    <div class="row g-0">
                        <div class="container">
                            <div class="card-body">
                                <button type="submit" class="btn btn-primary btn-sm">+
                                    Exercise</button>
                                    <!-- list selection for type input -->
                                    <select name="type" class="form-control" id="exampleFormControlSelect1">
                                        <option>MCQ</option>
                                        <option>MAQ</option>
                                        <option>Numeric</option>
                                        <option>Short Answer</option>
                                        <option>Long Answer</option>
                                        <option>Table</option>
                                    </select>
                            </div>
                        </div>
                    </div>
                </div>
            </form>


            <!-- add link back to part, align left -->
                    ‚¨ÖÔ∏è<a href="/pola/subject/part/<%=chapter._id %>"> Chapter <%=chapter.index+1%>:
                            <%= chapter.title %></a>
                    
                        <br>
                        <% if (nextChapter) { %>
                            <!-- span algin right -->
                            ‚û°Ô∏è<span>
                                <!-- add link to first chapter link. Name it chapter 1. align right -->
                                <a href="/pola/subject/part/<%=nextChapter._id %>"> Chapter <%=chapter.index+2%>:
                                        <%=nextChapter.title%> </a>
                            </span>
                            <% } else {%>
                                <!-- form to create new chapter. create POST route to pola/subject/<part>/chapter -->
                                <form action="/pola/subject/<%=chapter.part%>/chapter" method="POST"
                                    style="display: inline-block;">
                                    <a href="#" onclick="parentNode.submit(); return false;"> ‚ûï</a>
                                    <input name="title" type="text" id="exampleFormControlInput1" value="New Chapter">
                                </form>

                                <% }%>



<!-- Add mathjax to render latex equations -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- initialize mathjax -->
<script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>

